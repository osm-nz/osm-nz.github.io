<!DOCTYPE html>
<html>
  <head>
    <title>LINZ Address Import</title>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" href="./img/logo.png" />
    <style>
      * {
        font-family: Arial, Helvetica, sans-serif;
      }
      code {
        font-family: monospace;
        background-color: #ffdfeb;
        border-radius: 4px;
        padding: 2px 4px;
      }
      table {
        border-collapse: collapse;
      }
      tr {
        border-bottom: 0.5px solid #e1e1e1;
      }
    </style>
  </head>
  <body>
    <header hidden>
      {length} layers are available to import using JOSM. Some layers like
      Street Addresses are only available using the
      <a href="../../RapiD">fork of RapiD</a>.
      <ul>
        <li>
          When you checkout a layer, you will be given a <code>.osc</code> file.
          In JOSM, click <code>File --> Open</code> and select this file.
        </li>
        <li>
          When you checkout a layer, it will become unavailable to others for
          the next few hours. You don't have to upload the entire layer.
        </li>
        <li>
          Once a day, the list of layers will update, and any layers that were
          partially imported will be updated to only show the remaining items.
        </li>
      </ul>
    </header>
    <table>
      <thead>
        <th>Name</th>
        <th>Count</th>
        <th></th>
      </thead>
      <tbody></tbody>
    </table>
    <footer>
      For more infomation, see
      <a href="https://wiki.osm.org/LINZ">the wiki page</a>.
    </footer>
    <script>
      const $ = (id) => document.querySelector(id);

      async function checkout(name, url, _instructions) {
        const instructions = atob(_instructions);
        const msg = `Are you sure you want to checkout ${name}? ${
          instructions ? `\n\nInstructions for this layer: ${instructions}` : ""
        }`;
        if (confirm(msg)) {
          // chrome blocks cross-origin downloads so we turn it into a blob URL first
          const xmlBlob = await fetch(url.replace(".geo.json", ".osc")).then(
            (r) => r.blob()
          );
          const blobUrl = URL.createObjectURL(xmlBlob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = blobUrl;
          a.download = `${name}.osc`;
          a.target = "_blank";
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      }

      function lockedMsg([name, countOrDone]) {
        if (countOrDone === "done") {
          return `Imported by ${name}`;
        }
        return `${name} started editing ${Math.round(countOrDone)} minutes ago`;
      }

      const CDN_BASE_URL = "https://linz-addr-cdn.kyle.kiwi";
      async function main() {
        const { results } = await fetch(CDN_BASE_URL + "/index.json").then(
          (r) => r.json()
        );
        const locked = await fetch(CDN_BASE_URL + "/__locked").then((r) =>
          r.json()
        );

        const list = results.filter((x) => x.osmChangeAvailable);

        $("header").innerHTML = $("header").innerHTML.replace(
          "{length}",
          list.length
        );
        $("header").hidden = false;

        $("tbody").innerHTML = list
          .map((x) => {
            const prefix =
              x.groupCategories[0] === "/Categories/Preview"
                ? "<span style='color:red'>Preview:</span> "
                : "";
            const color =
              x.totalCount < 75
                ? "green"
                : x.totalCount < 200
                ? "orange"
                : "red";
            return `<tr>
              <td>${prefix}${x.name}</td>
              <td style='color:${color}'>${x.snippet}</td>
              <td>
                ${
                  locked[x.id]
                    ? lockedMsg(locked[x.id])
                    : `<button onclick='checkout("${x.name}", "${
                        x.url
                      }", "${btoa(x.instructions || "")}")'>Checkout</button>`
                }

              </td>
            </tr>`;
          })
          .join("");
      }
      main();
    </script>
  </body>
</html>
