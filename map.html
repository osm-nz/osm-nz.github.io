<!DOCTYPE html>
<html>
  <head>
    <title>All datasets</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="./img/logo.png" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin
    />
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin
    ></script>
    <style>
      * {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
      }
      #map {
        width: 100vw;
        height: 80vh;
      }
      #from-rapid-msg {
        text-align: center;
      }
      body {
        overflow-x: hidden;
      }
      .legend {
        line-height: 18px;
        color: #555;
      }
      .legend i {
        width: 18px;
        height: 18px;
        display: inline-block;
        margin-right: 8px;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div id="from-rapid-msg" hidden>
      <h3>Please select a suburb to edit</h3>
      You can close this page and use the list if you prefer
    </div>
    <div id="map"></div>
    <aside></aside>
    <script>
      // if rapid has opened this page in a popup
      const fromRapiD = !!window.opener;

      function returnToRapiD(id, locked) {
        if (locked) {
          const [user, minutesAgo] = locked;
          const suffix =
            "Check back in a day.\n\nIf you continue, you might override or duplicate their work!";
          const msg =
            minutesAgo === "done"
              ? `This dataset may already have been uploaded by someone else! ${suffix}`
              : `Someone else (${user}) started editing this dataset ${minutesAgo} minutes ago. ${suffix}`;

          if (!confirm(msg)) return;
        }

        window.opener.postMessage(`ADD_SECTOR=${id}`);
        window.close();
      }

      if (fromRapiD) {
        document.querySelector("#from-rapid-msg").hidden = false;
      }

      function getPolygon(x, isLocked) {
        const color =
          x.groupCategories[0] === "/Categories/Preview"
            ? "#0033ff"
            : isLocked
            ? "#aaaaaa"
            : getColor(x.totalCount);
        var fillOpacity = 0.3;
        var stroke = true;
        var opacity = 1;
        var weight = 2;

        return {
          color: color,
          fillOpacity: fillOpacity,
          opacity: opacity,
          stroke: stroke,
          weight: weight,
        };
      }

      var beforeHoveredColor = "orange"; // store colour of the hovered polygon
      function toggleFeatureHighlight(e, on) {
        // highlight polygon on mouse hover
        if (on) {
          beforeHoveredColor = e.target.options["color"];
          e.target.setStyle({ color: "yellow" });
        } else {
          e.target.setStyle({ color: beforeHoveredColor });
        }
      }

      // Return a deeper red for changesets with more changes
      function getColor(d) {
        return d > 1000
          ? "#3a0000"
          : d > 500
          ? "#67001f"
          : d > 200
          ? "#980043"
          : d > 100
          ? "#ce1256"
          : d > 60
          ? "#e7298a"
          : d > 40
          ? "#df65b0"
          : d > 20
          ? "#c994c7"
          : "#d4b9da";
      }

      function bboxToPoly([[minLng, minLat], [maxLng, maxLat]]) {
        if (!minLng || !minLat || !maxLng || !maxLat) return false;
        return [
          [maxLat, minLng], // NW
          [maxLat, maxLng], // NE
          [minLat, maxLng], // SE
          [minLat, minLng], // SW
        ];
      }
      var map = L.map("map").setView([-40.98, 166.9], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      const baseUrl = "https://linz-addr-cdn.kyle.kiwi";
      Promise.all([
        fetch(`${baseUrl}/index.json`).then((r) => r.json()),
        fetch(`${baseUrl}/__locked`)
          .then((r) => r.json())
          .catch(() => ({})),
      ])
        .then(([d, locked]) => {
          const [hide, show] = d.results.reduce(
            (ac, x) => {
              // don't show preview datasets on the map
              if (x.groupCategories[0] === "/Categories/Preview") return ac;

              // hide anything that spans more than 1deg of lat or lng
              const isBig =
                x.extent[1][0] - x.extent[0][0] > 1 ||
                x.extent[1][1] - x.extent[0][1] > 1;

              ac[+!isBig].push(x);
              return ac;
            },
            [[], []]
          );

          const getLockedMsg = (x) =>
            locked[x.id]
              ? `<br />Someone else ${
                  locked[x.id][1] === "done"
                    ? "may have already uploaded"
                    : "is working on"
                } this dataset! Check back in one day.`
              : "";

          if (hide.length) {
            document.querySelector("aside").innerHTML = `${
              hide.length
            } heinously large datasets have been hidden from the map: <ul>${hide
              .map((x) =>
                fromRapiD
                  ? `<li><a href="#" onClick='returnToRapiD("${
                      x.id
                    }", ${JSON.stringify(locked[x.id])})'>${x.name}</a> - ${
                      x.snippet
                    } ${getLockedMsg(x)}</li>`
                  : `<li>${x.name} - ${x.snippet} ${getLockedMsg(x)}</li>`
              )
              .join("")}</ul>`;
          }

          show.forEach((x) => {
            const poly = bboxToPoly(x.extent);
            if (poly) {
              var label = L.popup()
                .setLatLng(x.extent[0])
                .setContent(
                  `<strong>${x.name}</strong><br>${x.snippet} ${getLockedMsg(
                    x
                  )}`
                );
              // .openOn(map);
              const polygon = L.polygon(poly, getPolygon(x, locked[x.id]))
                .addTo(map)
                .bindTooltip(
                  `<strong>${x.name}</strong><br>${x.snippet} ${getLockedMsg(
                    x
                  )}`
                )
                .on("mouseover", function (ev) {
                  toggleFeatureHighlight(ev, true);
                })
                .on("mouseout", function (ev) {
                  toggleFeatureHighlight(ev, false);
                });

              if (fromRapiD)
                polygon.on("click", () => returnToRapiD(x.id, locked[x.id]));
              else polygon.bindPopup(label);
            }
          });
        })
        .catch((ex) => {
          console.error(ex);
          alert("Failed to load map");
        });

      // Legend
      var legend = L.control({ position: "bottomleft", margin: "20px" });

      legend.onAdd = function (map) {
        var div = L.DomUtil.create("div", "info legend"),
          grades = [0, 20, 40, 60, 100, 200, 500, 1000],
          labels = [];

        div.innerHTML = "<strong># of changes</strong><br/>";

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
          div.innerHTML +=
            '<i style="background:' +
            getColor(grades[i] + 1) +
            '"></i> ' +
            grades[i] +
            (grades[i + 1] ? "&ndash;" + grades[i + 1] + "<br>" : "+");
        }

        return div;
      };

      legend.addTo(map);
    </script>
  </body>
</html>
